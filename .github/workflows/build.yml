name: Build Bun Termux

on:
  push:
    branches: [main, master]
    paths:
      - 'packaging/**'
      - '.github/workflows/build.yml'
  pull_request:
    branches: [main, master]
  workflow_dispatch:
    inputs:
      version:
        description: 'Override version (e.g., 1.3.9)'
        required: false
        default: ''

jobs:
  build-pacman:
    runs-on: ubuntu-latest
    container:
      image: ghcr.io/termux/package-builder:latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Update PKGBUILD version
        if: ${{ github.event.inputs.version != '' }}
        run: |
          sed -i "s/^pkgver=.*/pkgver=${{ github.event.inputs.version }}/" packaging/pacman/PKGBUILD

      - name: Build pacman package
        run: |
          cd packaging/pacman
          makepkg -f --noconfirm

      - name: List packages
        run: |
          ls -la packaging/pacman/*.pkg.* || echo "No packages found"

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: bun-pacman-aarch64
          path: packaging/pacman/*.pkg.*
          retention-days: 30

  build-deb:
    runs-on: ubuntu-latest
    container:
      image: ghcr.io/termux/package-builder:latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install dependencies
        run: |
          apt-get update || true
          apt-get install -y curl unzip dpkg-dev || true

      - name: Download Bun musl binary
        env:
          BUN_VERSION: ${{ github.event.inputs.version || '1.3.9' }}
        run: |
          mkdir -p runtime
          curl -L "https://github.com/oven-sh/bun/releases/download/bun-v${BUN_VERSION}/bun-linux-aarch64-musl.zip" -o /tmp/bun.zip
          unzip -o /tmp/bun.zip -d /tmp/bun-extract
          BUN_BIN=$(find /tmp/bun-extract -name "bun" -type f | head -1)
          cp "$BUN_BIN" runtime/bun
          chmod +x runtime/bun

      - name: Build DEB package
        env:
          VERSION: ${{ github.event.inputs.version || '1.3.9' }}
        run: |
          mkdir -p packaging/dpkg
          bash scripts/package/package_deb.sh "$VERSION"

      - name: List packages
        run: |
          ls -la packaging/dpkg/*.deb || echo "No packages found"

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: bun-deb-aarch64
          path: packaging/dpkg/*.deb
          retention-days: 30

  release:
    needs: [build-pacman, build-deb]
    runs-on: ubuntu-latest
    if: startsWith(github.ref, 'refs/tags/')
    permissions:
      contents: write
    steps:
      - name: Download pacman artifact
        uses: actions/download-artifact@v4
        with:
          name: bun-pacman-aarch64
          path: dist/
        continue-on-error: true

      - name: Download deb artifact
        uses: actions/download-artifact@v4
        with:
          name: bun-deb-aarch64
          path: dist/
        continue-on-error: true

      - name: Create Release
        uses: softprops/action-gh-release@v1
        with:
          files: dist/*
          generate_release_notes: true
